{% extends "base.html" %} {% block title %}{{ travels.title }}{%endblock%} {% block content %}
<!--container-->
<div class="news-index">
    <div class="set-bg">
        <img src="/site_media/{{ travels.bigimage }}" alt="" class="scenery-img" />
    </div>
    <div class="row">
        <div class="h1-title">{{ travels.title }}</div>
        <div class="per-img">
           {% for users in users %}
                    {% if users.id = travels.author_id %}
                    <img src="/site_media/{{ users.mugshot }}" alt=""/>
                    {% endif %}
                    {% endfor %}
        </div>
    </div>
</div>
<div class="share-box">
    <div class="row">
        <div class="per-info">
            <a href="">{{travels.author}}</a>
            <span>{{travels.pub_date|date:"Y-m-d"}}</span>
            <i class="icon iconfont">&#xe605;</i>{{ travels.count_hit }}
        </div>
        <div class="share">
            <div class="fleft">
                {% if favis|length == 1 %}
                <a class="fav-btn" ><i class="cur"></i></a>
                {% else %}
                    <a class="fav-btn" ><i class=""></i></a>
                {% endif %}
                    <span>{{ favlistall|length }}</span>
                    <strong>收藏</strong>

            </div>
            <div class="fright">
                <div class="bdsharebuttonbox">
                    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
                    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
                    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="rds-container">
    <div class="rds-main">
        <div class="news-list">
            <div class="news-content">
                {{ travels.content|safe }}
            </div>
        </div>
        <div class="comments">
        <div class="comment-tit">
            关于本篇游记,看看大家怎么说~
        </div>
            {% load comments %} 
            {% get_comment_list for travels as comment_list %}
            {% for comment in comment_list %}
            <div class="com-list">
                <div class="author-info">
                    <div class="author-pic">    
                    {% for users in users %}
                    {% if users.user_id = comment.user_id %}
                    <img src="/site_media/{{ users.mugshot }}" alt="{{ comment.user_name }}" />
                    {% endif %}
                    {% endfor %} 
                
                    </div>
                    <span class="author-name"><a href="">{{comment.user_name}}</a></span>
                    <span class="date">{{comment.submit_date}}</span>
                </div>
                <div class="com-content">
                    {{comment.comment|safe}}
                </div>
            </div>
            {%endfor%}


            <div class="com-textar">
            {% if user.is_authenticated %}
            {% get_comment_form for travels as form %}
            <form action="{%comment_form_target%}" method="post">
                {%csrf_token%} 
                {{form.object_pk}}
                 {{form.content_type}} 
                 {{form.timestamp}} 
                 {{form.security_hash}}
                <div class="avatar">
                    <a href="" title="{{ user.username }}">
                    {% for users in users %}
                    {% if users.user_id = user.id %}
                    <img src="/site_media/{{ users.mugshot }}" alt="{{ user.username }}" />
                    {% endif %}
                    {% endfor %} 
                    </a>
                </div>
                <div class="com-text">
                    <h2>回复内容</h2>
                    <div class="face-btn">
                        <img src="/static/images/face-icon.png" alt=""/>
                    </div>
                    <div class="face-pop art-newpop">
                        <div class="face-tab">
                            <ul>
                                <li class="cur">常用表情</li>
                                <li >小恐龙</li>
                            </ul>
                        </div>
                        <div class="face-icon face-icon1"><ul></ul></div>
                        <div class="face-icon face-icon2"><ul></ul></div>
                    </div>
                    <div class="com-box">
                        <textarea name="comment" id="evx" cols="30" rows="8"></textarea>
                    </div>

                </div>
                <p style="display:none">
                    <label for="id_honeypot">如果你这该字段中输入任何内容，那么你的评论就会被视为垃圾评论。</label>
                    <input type="text" name="honeypot" id="id_honeypot">
                </p>

                <input type="submit" name="post" value="发表回复" class="com-submit">
                <input type="hidden" name="next" value="/travels/{{ travels.id }}">


            </form>
            {% else %} 请
            <a href="/accounts/signin">登录</a>,或<a href="/accounts/signup">注册</a>后再评论 {% endif %}
            </div>

        </div>
    
    </div>
    <div class="siderbar">
        <div class="lately-news">
            <div class="sider-title">
                最新游记
            </div>
            <ul>
            {% for travels in travelsall|slice:":3" %}
                <li>
                    <a href="/blog/{{ travels.id }}">
                        <img src="/site_media/{{ travels.image }}" alt="" />
                        <p>{{ travels.title|slice:":52" }}...</p>
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div class="lately-news">
            <div class="sider-title">
                相关游记
            </div>
            <ul>

                <li>

                </li>

            </ul>
        </div>
    </div>
</div>
 <div class="fav-note">
     <iframe src=""  height="35" frameborder="0"></iframe>
 </div>
<script>
$(function () {
   $('.fav-btn i').click(function () {
       $(this).addClass('cur');
       $('.fav-note').show() ;
       url = "/addfav/"+{{ travels.id }};
       $('.fav-note iframe').attr('src',url);
       setTimeout(function () {
           $('.fav-note').hide();
       },2000);

   })


})
</script>

<!--baidu share js-->
<script>
window._bd_share_config = {
    "common": {
        "bdSnsKey": {},
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": "",
        "bdStyle": "0",
        "bdSize": "24"
    },
    "share": {},
    "image": {
        "viewList": ["tsina", "qzone", "weixin"],
        "viewText": "分享到：",
        "viewSize": "16"
    },
    "selectShare": {
        "bdContainerClass": null,
        "bdSelectMiniList": ["tsina", "qzone", "weixin"]
    }
};
with(document) 0[(getElementsByTagName('head')[0] || body).appendChild(createElement('script')).src = 'http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=' + ~(-new Date() / 36e5)];
</script>

<script>
    $(document).ready(function(e) {
        $('.face-icon1').show();
        $('.face-tab li').each(function () {
            $(this).click(function (e) {
                $(this).addClass('cur').siblings().removeClass('cur');
                num = $(this).index();
                $('.face-icon'+(num+1)).show().siblings('.face-icon').hide();
                e.stopPropagation();
            })
        })
        $('.face-btn img').click(function (e) {
            $('.face-pop').show();
            e.stopPropagation();
        })
        $(document).click(function () {
            $('.face-pop').hide();
        })

        $.ajax( {
            type: "post",
            dataType : 'json',
            url : '/static/js/emotions.json',
            success : function(data) {
                var legth = data.konglong.length;
                var legth2 = data.changy.length;
                for(var i = 0;i<legth;i++){
                    $('.face-icon2 ul').append('<li title="'+ data.konglong[i].title +'"><img src="' + data.konglong[i].imgurl + '" /></li>')
                }
                for(var i = 0;i<legth2;i++){
                    $('.face-icon1 ul').append('<li title="'+ data.changy[i].title +'"><img src="' + data.changy[i].imgurl + '" /></li>')
                }
                $('.face-icon ul li').each(function () {
                    $(this).click(function () {
                        var areaval = $('.com-box textarea').val();
                        var valText = areaval + '('+$(this).attr('title')+')';
                        $('.com-box textarea').val(valText).focus();
                        $('.face-pop').hide();
                    })
                })
            }
        });

        //提交
        $('.com-submit').click(function () {
            var areaval = $('.com-box textarea').val();
            $('.com-box textarea').val(replace_em(areaval));
            //console.log(replace_em(areaval));
        })
    });

    function replace_em(str){
        var areaval = $('.com-box textarea').val();
        pattern =new RegExp("\\((.| )+?\\)","igm");
        textarr = areaval.match(pattern);
        areaval = areaval.replace(/\</g,'&lt;');
        areaval = areaval.replace(/\>/g,'&gt;');
        areaval = areaval.replace(/\n/g,'<br/>');
        areaval = areaval.replace(/\(/g,'');
        areaval = areaval.replace(/\)/g,'');
        if(textarr){
            for(var i=0;i<textarr.length;i++){
                item = textarr[i].split(/[()]/)[1];
                console.log(item);
                var llist = $('.face-icon ul li');
                for(var n=0;n<llist.length;n++){
                    if(item == llist.eq(n).attr('title')){
                        newstr = llist.eq(n).html();
                    }
                }
                areaval = areaval.replace(item,newstr);
            }
            str = areaval;
            return str;
        }
        else{
            return str;
        }

    }

</script>
<!--end share-->
{% endblock %}
